From 4a0d468bba05a431357b6522203db07e5565a968 Mon Sep 17 00:00:00 2001
From: wszqkzqk <wszqkzqk@qq.com>
Date: Thu, 3 Nov 2022 21:57:10 +0800
Subject: [PATCH 1/5] vala: Minor scanner optimization

---
 vala/valageniescanner.vala | 10 +++++-----
 vala/valascanner.vala      | 10 +++++-----
 2 files changed, 10 insertions(+), 10 deletions(-)

diff --git a/vala/valageniescanner.vala b/vala/valageniescanner.vala
index 286992206..48088f3ee 100644
--- a/vala/valageniescanner.vala
+++ b/vala/valageniescanner.vala
@@ -94,23 +94,23 @@ public class Vala.Genie.Scanner {
 
 	}
 
-	bool in_template () {
+	inline bool in_template () {
 		return (state_stack.length > 0 && state_stack[state_stack.length - 1] == State.TEMPLATE);
 	}
 
-	bool in_verbatim_template () {
+	inline bool in_verbatim_template () {
 		return (state_stack.length > 0 && state_stack[state_stack.length - 1] == State.VERBATIM_TEMPLATE);
 	}
 
-	bool in_template_part () {
+	inline bool in_template_part () {
 		return (state_stack.length > 0 && state_stack[state_stack.length - 1] == State.TEMPLATE_PART);
 	}
 
-	bool is_ident_char (char c) {
+	inline bool is_ident_char (char c) {
 		return (c.isalnum () || c == '_');
 	}
 
-	bool in_regex_literal () {
+	inline bool in_regex_literal () {
 		return (state_stack.length > 0 && state_stack[state_stack.length - 1] == State.REGEX_LITERAL);
 	}
 
diff --git a/vala/valascanner.vala b/vala/valascanner.vala
index 13a4698b6..3c87115e1 100644
--- a/vala/valascanner.vala
+++ b/vala/valascanner.vala
@@ -79,23 +79,23 @@ public class Vala.Scanner {
 		state_stack = null;
 	}
 
-	bool in_template () {
+	inline bool in_template () {
 		return (state_stack.length > 0 && state_stack[state_stack.length - 1] == State.TEMPLATE);
 	}
 
-	bool in_verbatim_template () {
+	inline bool in_verbatim_template () {
 		return (state_stack.length > 0 && state_stack[state_stack.length - 1] == State.VERBATIM_TEMPLATE);
 	}
 
-	bool in_template_part () {
+	inline bool in_template_part () {
 		return (state_stack.length > 0 && state_stack[state_stack.length - 1] == State.TEMPLATE_PART);
 	}
 
-	bool in_regex_literal () {
+	inline bool in_regex_literal () {
 		return (state_stack.length > 0 && state_stack[state_stack.length - 1] == State.REGEX_LITERAL);
 	}
 
-	bool is_ident_char (char c) {
+	inline bool is_ident_char (char c) {
 		return (c.isalnum () || c == '_');
 	}
 
-- 
2.38.1.windows.1


From fa09ca11b9467614bdca514acbbbe3baddfd7dfa Mon Sep 17 00:00:00 2001
From: Simon Werbeck <simon.werbeck@gmail.com>
Date: Tue, 17 Jul 2012 18:30:51 +0200
Subject: [PATCH 2/5] vala: Fix assignment operators for element access

This transforms an assignment to element access other than `=' to a
binary expression i.e. `a[b] += 1' will become `a.set(a.get(b) + 1)'

Fixes https://gitlab.gnome.org/GNOME/vala/issues/135
---
 tests/Makefile.am                             |   1 +
 ...ssignment-element-getter-setter.c-expected | 140 ++++++++++++++++++
 .../assignment-element-getter-setter.vala     |  35 +++++
 vala/valaassignment.vala                      |  30 ++++
 4 files changed, 206 insertions(+)
 create mode 100644 tests/semantic/assignment-element-getter-setter.c-expected
 create mode 100644 tests/semantic/assignment-element-getter-setter.vala

diff --git a/tests/Makefile.am b/tests/Makefile.am
index b93d4963c..4536dcb3b 100644
--- a/tests/Makefile.am
+++ b/tests/Makefile.am
@@ -1045,6 +1045,7 @@ TESTS = \
 	semantic/array-length-nullable.test \
 	semantic/array-too-few-type-arguments.test \
 	semantic/array-too-many-type-arguments.test \
+	semantic/assignment-element-getter-setter.vala \
 	semantic/assignment-element-incompatible-ownership.test \
 	semantic/assignment-element-incompatible-type.test \
 	semantic/assignment-fixed-array-length.test \
diff --git a/tests/semantic/assignment-element-getter-setter.c-expected b/tests/semantic/assignment-element-getter-setter.c-expected
new file mode 100644
index 000000000..b0abb879d
--- /dev/null
+++ b/tests/semantic/assignment-element-getter-setter.c-expected
@@ -0,0 +1,140 @@
+/* semantic_assignment_element_getter_setter.c generated by valac, the Vala compiler
+ * generated from semantic_assignment_element_getter_setter.vala, do not modify */
+
+#include <glib.h>
+
+#if !defined(VALA_EXTERN)
+#if defined(_MSC_VER)
+#define VALA_EXTERN __declspec(dllexport) extern
+#elif __GNUC__ >= 4
+#define VALA_EXTERN __attribute__((visibility("default"))) extern
+#else
+#define VALA_EXTERN extern
+#endif
+#endif
+
+typedef struct _Foo Foo;
+#define _foo_free0(var) ((var == NULL) ? NULL : (var = (foo_free (var), NULL)))
+#define _vala_assert(expr, msg) if G_LIKELY (expr) ; else g_assertion_message_expr (G_LOG_DOMAIN, __FILE__, __LINE__, G_STRFUNC, msg);
+#define _vala_return_if_fail(expr, msg) if G_LIKELY (expr) ; else { g_return_if_fail_warning (G_LOG_DOMAIN, G_STRFUNC, msg); return; }
+#define _vala_return_val_if_fail(expr, msg, val) if G_LIKELY (expr) ; else { g_return_if_fail_warning (G_LOG_DOMAIN, G_STRFUNC, msg); return val; }
+#define _vala_warn_if_fail(expr, msg) if G_LIKELY (expr) ; else g_warn_message (G_LOG_DOMAIN, __FILE__, __LINE__, G_STRFUNC, msg);
+
+struct _Foo {
+	gpointer* elements;
+	gint elements_length1;
+};
+
+VALA_EXTERN void foo_free (Foo * self);
+G_DEFINE_AUTOPTR_CLEANUP_FUNC (Foo, foo_free)
+static void foo_instance_init (Foo * self);
+VALA_EXTERN Foo* foo_new (void);
+VALA_EXTERN gpointer foo_get (Foo* self,
+                  gint idx);
+VALA_EXTERN void foo_set (Foo* self,
+              gint idx,
+              gconstpointer val);
+static void _vala_main (void);
+
+Foo*
+foo_new (void)
+{
+	Foo* self;
+	gpointer* _tmp0_;
+	self = g_slice_new0 (Foo);
+	foo_instance_init (self);
+	_tmp0_ = g_new0 (gpointer, 1);
+	_tmp0_[0] = NULL;
+	self->elements = (g_free (self->elements), NULL);
+	self->elements = _tmp0_;
+	self->elements_length1 = 1;
+	return self;
+}
+
+gpointer
+foo_get (Foo* self,
+         gint idx)
+{
+	gpointer* _tmp0_;
+	gint _tmp0__length1;
+	gconstpointer _tmp1_;
+	gpointer result;
+	g_return_val_if_fail (self != NULL, NULL);
+	_tmp0_ = self->elements;
+	_tmp0__length1 = self->elements_length1;
+	_tmp1_ = _tmp0_[idx];
+	result = _tmp1_;
+	return result;
+}
+
+void
+foo_set (Foo* self,
+         gint idx,
+         gconstpointer val)
+{
+	gpointer* _tmp0_;
+	gint _tmp0__length1;
+	g_return_if_fail (self != NULL);
+	_tmp0_ = self->elements;
+	_tmp0__length1 = self->elements_length1;
+	_tmp0_[idx] = val;
+}
+
+static void
+foo_instance_init (Foo * self)
+{
+}
+
+void
+foo_free (Foo * self)
+{
+	self->elements = (g_free (self->elements), NULL);
+	g_slice_free (Foo, self);
+}
+
+static void
+_vala_main (void)
+{
+	Foo* foo = NULL;
+	Foo* _tmp0_;
+	gpointer _tmp1_;
+	gpointer _tmp2_;
+	gpointer _tmp3_;
+	gpointer _tmp4_;
+	gpointer _tmp5_;
+	gpointer _tmp6_;
+	gpointer _tmp7_;
+	gpointer _tmp8_;
+	gpointer _tmp9_;
+	_tmp0_ = foo_new ();
+	foo = _tmp0_;
+	foo_set (foo, 0, (gpointer) ((gintptr) 23));
+	_tmp1_ = foo_get (foo, 0);
+	_vala_assert (((gint) ((gintptr) _tmp1_)) == 23, "foo[0] == 23");
+	_tmp2_ = foo_get (foo, 0);
+	foo_set (foo, 0, (gpointer) ((gintptr) (((gint) ((gintptr) _tmp2_)) + 42)));
+	_tmp3_ = foo_get (foo, 0);
+	_vala_assert (((gint) ((gintptr) _tmp3_)) == 65, "foo[0] == 65");
+	_tmp4_ = foo_get (foo, 0);
+	foo_set (foo, 0, (gpointer) ((gintptr) (((gint) ((gintptr) _tmp4_)) * 2)));
+	_tmp5_ = foo_get (foo, 0);
+	_vala_assert (((gint) ((gintptr) _tmp5_)) == 130, "foo[0] == 130");
+	_tmp6_ = foo_get (foo, 0);
+	foo_set (foo, 0, (gpointer) ((gintptr) (((gint) ((gintptr) _tmp6_)) / 5)));
+	_tmp7_ = foo_get (foo, 0);
+	_vala_assert (((gint) ((gintptr) _tmp7_)) == 26, "foo[0] == 26");
+	_tmp8_ = foo_get (foo, 0);
+	foo_set (foo, 0, (gpointer) ((gintptr) (((gint) ((gintptr) _tmp8_)) - 4711)));
+	_tmp9_ = foo_get (foo, 0);
+	_vala_assert (((gint) ((gintptr) _tmp9_)) == -4685, "foo[0] == -4685");
+	_foo_free0 (foo);
+}
+
+int
+main (int argc,
+      char ** argv)
+{
+	_vala_main ();
+	return 0;
+}
+
diff --git a/tests/semantic/assignment-element-getter-setter.vala b/tests/semantic/assignment-element-getter-setter.vala
new file mode 100644
index 000000000..8399dc0d6
--- /dev/null
+++ b/tests/semantic/assignment-element-getter-setter.vala
@@ -0,0 +1,35 @@
+[Compact]
+public class Foo<G> {
+	public G[] elements;
+
+	public Foo () {
+		elements = new G[] { null };
+	}
+
+	public G get (int idx) {
+		return elements[idx];
+	}
+
+	public void set (int idx, G val) {
+		elements[idx] = val;
+	}
+}
+
+void main () {
+	var foo = new Foo<int> ();
+
+	foo[0] = 23;
+	assert (foo[0] == 23);
+
+	foo[0] += 42;
+	assert (foo[0] == 65);
+
+	foo[0] *= 2;
+	assert (foo[0] == 130);
+
+	foo[0] /= 5;
+	assert (foo[0] == 26);
+
+	foo[0] -= 4711;
+	assert (foo[0] == -4685);
+}
diff --git a/vala/valaassignment.vala b/vala/valaassignment.vala
index 150c34723..929fa7b66 100644
--- a/vala/valaassignment.vala
+++ b/vala/valaassignment.vala
@@ -204,6 +204,36 @@ public class Vala.Assignment : Expression {
 				foreach (Expression e in ea.get_indices ()) {
 					set_call.add_argument (e);
 				}
+
+				if (operator != AssignmentOperator.SIMPLE && ea.container.value_type.get_member ("get") is Method) {
+					// transform into binary expression inside set call
+					var get_call = new MethodCall (new MemberAccess (ea.container, "get", source_reference), source_reference);
+					foreach (Expression e in ea.get_indices ()) {
+						get_call.add_argument (e);
+					}
+
+					BinaryOperator bop;
+
+					switch (operator) {
+					case AssignmentOperator.BITWISE_OR: bop = BinaryOperator.BITWISE_OR; break;
+					case AssignmentOperator.BITWISE_AND: bop = BinaryOperator.BITWISE_AND; break;
+					case AssignmentOperator.BITWISE_XOR: bop = BinaryOperator.BITWISE_XOR; break;
+					case AssignmentOperator.ADD: bop = BinaryOperator.PLUS; break;
+					case AssignmentOperator.SUB: bop = BinaryOperator.MINUS; break;
+					case AssignmentOperator.MUL: bop = BinaryOperator.MUL; break;
+					case AssignmentOperator.DIV: bop = BinaryOperator.DIV; break;
+					case AssignmentOperator.PERCENT: bop = BinaryOperator.MOD; break;
+					case AssignmentOperator.SHIFT_LEFT: bop = BinaryOperator.SHIFT_LEFT; break;
+					case AssignmentOperator.SHIFT_RIGHT: bop = BinaryOperator.SHIFT_RIGHT; break;
+					default:
+						error = true;
+						Report.error (source_reference, "internal error: unsupported assignment operator");
+						return false;
+					}
+
+					right = new BinaryExpression (bop, get_call, right, source_reference);
+				}
+
 				set_call.add_argument (right);
 				parent_node.replace_expression (this, set_call);
 				return set_call.check (context);
-- 
2.38.1.windows.1


From 53983be179a3fc46c901cb423022cac9bfc01ad5 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?=E6=98=9F=E5=A4=96=E4=B9=8B=E7=A5=9E?= <wszqkzqk@qq.com>
Date: Sun, 20 Nov 2022 13:49:01 +0800
Subject: [PATCH 3/5] Squashed commit of the following:
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

commit ad4a49a75f45f5424ace16ad8758043873da1eaa
Author: wszqkzqk <wszqkzqk@qq.com>
Date:   Fri Oct 28 11:24:08 2022 +0800

    fix ambiguous variable names

commit 1637cbc046571542fe214b95e08452431d208b9d
Author: 星外之神 <wszqkzqk@qq.com>
Date:   Wed Oct 26 09:29:08 2022 +0800

    simplify the implementation

commit c92403d7e34a6a27f6d87bb8d58f4d33e706d37c
Author: Rico Tzschichholz <ricotz@ubuntu.com>
Date:   Tue Oct 25 12:57:08 2022 +0200

    tests: More tests

commit ebfafa970c5dd466d6e7e4079a82e3dc9c4ed5be
Author: wszqkzqk <wszqkzqk@qq.com>
Date:   Tue Oct 25 18:35:52 2022 +0800

    fix the wrong use of isxdigit

commit c2241589caa48fb9a88bc860a8ffedbb1ba57b14
Author: Rico Tzschichholz <ricotz@ubuntu.com>
Date:   Tue Oct 25 08:27:04 2022 +0200

    tests: Add some underscore separated number tests

commit 9a0acc61720194deb2f8032109d3fb3171ac39e0
Author: 星外之神 <wszqkzqk@qq.com>
Date:   Tue Oct 25 00:27:56 2022 +0800

    genie: Support underscores separate  in numbers

commit 8c7c136c475e05fe17915f2fa67f2259717e2ac7
Author: 星外之神 <wszqkzqk@qq.com>
Date:   Tue Oct 25 00:07:41 2022 +0800

    Support the underscore separates digits in numbers
---
 tests/Makefile.am                             |  5 +++
 .../number_underscore_separated.c-expected    | 30 +++++++++++++
 .../scanner/number_underscore_separated.vala  |  6 +++
 .../number_underscore_separated_invalid.test  |  5 +++
 .../number_underscore_separated_invalid2.test |  5 +++
 .../number_underscore_separated_invalid3.test |  5 +++
 .../number_underscore_separated_invalid4.test |  5 +++
 .../number_underscore_separated_invalid5.test |  5 +++
 vala/valageniescanner.vala                    | 44 +++++++++++++++----
 vala/valaintegerliteral.vala                  |  4 ++
 vala/valarealliteral.vala                     |  4 ++
 vala/valascanner.vala                         | 44 +++++++++++++++----
 vapi/v4l2.vapi                                |  4 +-
 13 files changed, 148 insertions(+), 18 deletions(-)
 create mode 100644 tests/scanner/number_underscore_separated.c-expected
 create mode 100644 tests/scanner/number_underscore_separated.vala
 create mode 100644 tests/scanner/number_underscore_separated_invalid.test
 create mode 100644 tests/scanner/number_underscore_separated_invalid2.test
 create mode 100644 tests/scanner/number_underscore_separated_invalid3.test
 create mode 100644 tests/scanner/number_underscore_separated_invalid4.test
 create mode 100644 tests/scanner/number_underscore_separated_invalid5.test

diff --git a/tests/Makefile.am b/tests/Makefile.am
index 4536dcb3b..3b3291f24 100644
--- a/tests/Makefile.am
+++ b/tests/Makefile.am
@@ -890,6 +890,11 @@ TESTS = \
 	annotations/description.vala \
 	annotations/noaccessormethod.test \
 	scanner/comment-not-closed.test \
+	scanner/number_underscore_separated.vala \
+	scanner/number_underscore_separated_invalid.test \
+	scanner/number_underscore_separated_invalid2.test \
+	scanner/number_underscore_separated_invalid3.test \
+	scanner/number_underscore_separated_invalid4.test \
 	scanner/preprocessor-invalid.test \
 	scanner/preprocessor-missing-paren.test \
 	scanner/preprocessor-unexpected.test \
diff --git a/tests/scanner/number_underscore_separated.c-expected b/tests/scanner/number_underscore_separated.c-expected
new file mode 100644
index 000000000..3500e2504
--- /dev/null
+++ b/tests/scanner/number_underscore_separated.c-expected
@@ -0,0 +1,30 @@
+/* scanner_number_underscore_separated.c generated by valac, the Vala compiler
+ * generated from scanner_number_underscore_separated.vala, do not modify */
+
+#include <glib.h>
+#include <float.h>
+#include <math.h>
+
+static void _vala_main (void);
+
+static void
+_vala_main (void)
+{
+	gfloat foo = 0.0F;
+	gdouble baz = 0.0;
+	guint64 bar = 0ULL;
+	gint64 minim = 0LL;
+	foo = 3.1415926535897932f;
+	baz = 6022140.76e-1023;
+	bar = 299792458ULL;
+	minim = -0x80000001LL;
+}
+
+int
+main (int argc,
+      char ** argv)
+{
+	_vala_main ();
+	return 0;
+}
+
diff --git a/tests/scanner/number_underscore_separated.vala b/tests/scanner/number_underscore_separated.vala
new file mode 100644
index 000000000..045c27f5f
--- /dev/null
+++ b/tests/scanner/number_underscore_separated.vala
@@ -0,0 +1,6 @@
+void main () {
+	float foo = 3.141_592_653_589_793_2f;
+	double baz = 6_022_140.76e-1_023;
+	uint64 bar = 299_792_458ull;
+	int64 minim = -0x80_00_00_01LL;
+}
diff --git a/tests/scanner/number_underscore_separated_invalid.test b/tests/scanner/number_underscore_separated_invalid.test
new file mode 100644
index 000000000..04c2018a3
--- /dev/null
+++ b/tests/scanner/number_underscore_separated_invalid.test
@@ -0,0 +1,5 @@
+Invalid Code
+
+void main () {
+	double foo = _3.141;
+}
diff --git a/tests/scanner/number_underscore_separated_invalid2.test b/tests/scanner/number_underscore_separated_invalid2.test
new file mode 100644
index 000000000..3265172e5
--- /dev/null
+++ b/tests/scanner/number_underscore_separated_invalid2.test
@@ -0,0 +1,5 @@
+Invalid Code
+
+void main () {
+	double foo = 3._141;
+}
diff --git a/tests/scanner/number_underscore_separated_invalid3.test b/tests/scanner/number_underscore_separated_invalid3.test
new file mode 100644
index 000000000..fde08221a
--- /dev/null
+++ b/tests/scanner/number_underscore_separated_invalid3.test
@@ -0,0 +1,5 @@
+Invalid Code
+
+void main () {
+	double foo = 3.14__1;
+}
diff --git a/tests/scanner/number_underscore_separated_invalid4.test b/tests/scanner/number_underscore_separated_invalid4.test
new file mode 100644
index 000000000..56d1887d5
--- /dev/null
+++ b/tests/scanner/number_underscore_separated_invalid4.test
@@ -0,0 +1,5 @@
+Invalid Code
+
+void main () {
+	double foo = 3.141_;
+}
diff --git a/tests/scanner/number_underscore_separated_invalid5.test b/tests/scanner/number_underscore_separated_invalid5.test
new file mode 100644
index 000000000..8d3783b65
--- /dev/null
+++ b/tests/scanner/number_underscore_separated_invalid5.test
@@ -0,0 +1,5 @@
+Invalid Code
+
+void main () {
+	double foo = 3141e-3_;
+}
diff --git a/vala/valageniescanner.vala b/vala/valageniescanner.vala
index 48088f3ee..16caa9ea8 100644
--- a/vala/valageniescanner.vala
+++ b/vala/valageniescanner.vala
@@ -999,8 +999,15 @@ public class Vala.Genie.Scanner {
 				type = TokenType.IDENTIFIER;
 			}
 		} else if (current[0].isdigit ()) {
-			while (current < end && current[0].isdigit ()) {
-				current++;
+			while (current < end) {
+				if (current[0].isdigit ()) {
+					current++;
+				} else if (current[0] == '_' && current < end -1 && current[1].isdigit ()) {
+					// Support the underscore symbol separates digits in number values
+					current++;
+				} else {
+					break;
+				}
 			}
 			type = TokenType.INTEGER_LITERAL;
 			if (current < end && current[0].tolower () == 'l') {
@@ -1018,16 +1025,30 @@ public class Vala.Genie.Scanner {
 				}
 			} else if (current < end - 1 && current[0] == '.' && current[1].isdigit ()) {
 				current++;
-				while (current < end && current[0].isdigit ()) {
-					current++;
+				while (current < end) {
+					if (current[0].isdigit ()) {
+						current++;
+					} else if (current[0] == '_' && current < end -1 && current[1].isdigit ()) {
+						// Support the underscore symbol separates digits in number values
+						current++;
+					} else {
+						break;
+					}
 				}
 				if (current < end && current[0].tolower () == 'e') {
 					current++;
 					if (current < end && (current[0] == '+' || current[0] == '-')) {
 						current++;
 					}
-					while (current < end && current[0].isdigit ()) {
-						current++;
+					while (current < end) {
+						if (current[0].isdigit ()) {
+							current++;
+						} else if (current[0] == '_' && current < end -1 && current[1].isdigit ()) {
+							// Support the underscore symbol separates digits in number values
+							current++;
+						} else {
+							break;
+						}
 					}
 				}
 				if (current < end && current[0].tolower () == 'f') {
@@ -1038,8 +1059,15 @@ public class Vala.Genie.Scanner {
 					   && begin[0] == '0' && begin[1] == 'x' && begin[2].isxdigit ()) {
 				// hexadecimal integer literal
 				current++;
-				while (current < end && current[0].isxdigit ()) {
-					current++;
+				while (current < end) {
+					if (current[0].isxdigit ()) {
+						current++;
+					} else if (current[0] == '_' && current < end -1 && current[1].isxdigit ()) {
+						// Support the underscore symbol separates digits in number values
+						current++;
+					} else {
+						break;
+					}
 				}
 			} else if (current < end && is_ident_char (current[0])) {
 				// allow identifiers to start with a digit
diff --git a/vala/valaintegerliteral.vala b/vala/valaintegerliteral.vala
index e28960126..4fc8e890b 100644
--- a/vala/valaintegerliteral.vala
+++ b/vala/valaintegerliteral.vala
@@ -66,6 +66,10 @@ public class Vala.IntegerLiteral : Literal {
 
 		checked = true;
 
+		// Support the underscore symbol separates digits in number values
+		string[] components = value.split ("_");
+		value = string.joinv("", components);
+
 		int l = 0;
 		while (value.has_suffix ("l") || value.has_suffix ("L")) {
 			l++;
diff --git a/vala/valarealliteral.vala b/vala/valarealliteral.vala
index c992fba6f..4995cdd02 100644
--- a/vala/valarealliteral.vala
+++ b/vala/valarealliteral.vala
@@ -64,6 +64,10 @@ public class Vala.RealLiteral : Literal {
 
 		checked = true;
 
+		// Support the underscore symbol separates digits in number values
+		string[] components = value.split ("_");
+		value = string.joinv("", components);
+
 		string type_name;
 		if (value.has_suffix ("f") || value.has_suffix ("F")) {
 			type_name ="float";
diff --git a/vala/valascanner.vala b/vala/valascanner.vala
index 3c87115e1..71a317edd 100644
--- a/vala/valascanner.vala
+++ b/vala/valascanner.vala
@@ -611,13 +611,27 @@ public class Vala.Scanner {
 		    && current[1] == 'x' && current[2].isxdigit ()) {
 			// hexadecimal integer literal
 			current += 2;
-			while (current < end && current[0].isxdigit ()) {
-				current++;
+			while (current < end) {
+				if (current[0].isxdigit ()) {
+					current++;
+				} else if (current[0] == '_' && current < end -1 && current[1].isxdigit ()) {
+					// Support the underscore symbol separates digits in number values
+					current++;
+				} else {
+					break;
+				}
 			}
 		} else {
 			// decimal number
-			while (current < end && current[0].isdigit ()) {
-				current++;
+			while (current < end) {
+				if (current[0].isdigit ()) {
+					current++;
+				} else if (current[0] == '_' && current < end -1 && current[1].isdigit ()) {
+					// Support the underscore symbol separates digits in number values
+					current++;
+				} else {
+					break;
+				}
 			}
 		}
 
@@ -625,8 +639,15 @@ public class Vala.Scanner {
 		if (current < end - 1 && current[0] == '.' && current[1].isdigit ()) {
 			type = TokenType.REAL_LITERAL;
 			current++;
-			while (current < end && current[0].isdigit ()) {
-				current++;
+			while (current < end) {
+				if (current[0].isdigit ()) {
+					current++;
+				} else if (current[0] == '_' && current < end -1 && current[1].isdigit ()) {
+					// Support the underscore symbol separates digits in number values
+					current++;
+				} else {
+					break;
+				}
 			}
 		}
 
@@ -637,8 +658,15 @@ public class Vala.Scanner {
 			if (current < end && (current[0] == '+' || current[0] == '-')) {
 				current++;
 			}
-			while (current < end && current[0].isdigit ()) {
-				current++;
+			while (current < end) {
+				if (current[0].isdigit ()) {
+					current++;
+				} else if (current[0] == '_' && current < end -1 && current[1].isdigit ()) {
+					// Support the underscore symbol separates digits in number values
+					current++;
+				} else {
+					break;
+				}
 			}
 		}
 
diff --git a/vapi/v4l2.vapi b/vapi/v4l2.vapi
index 129f52a14..4c4b90ca8 100644
--- a/vapi/v4l2.vapi
+++ b/vapi/v4l2.vapi
@@ -559,8 +559,8 @@ namespace V4l2
 		NTSC,
 		SECAM_DK,
 		SECAM,
-		525_60,
-		625_50,
+		@525_60,
+		@625_50,
 		ATSC,
 		UNKNOWN,
 		ALL
-- 
2.38.1.windows.1


From 5664431d3f70a509bfe80a6e04d72f6769a77155 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?=E6=98=9F=E5=A4=96=E4=B9=8B=E7=A5=9E?= <wszqkzqk@qq.com>
Date: Sun, 20 Nov 2022 13:50:13 +0800
Subject: [PATCH 4/5] Squashed commit of the following:
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

commit f5aa16e1836659c38d271e17a197ceca060b30a7
Author: 星外之神 <wszqkzqk@qq.com>
Date:   Sun Nov 20 13:42:01 2022 +0800

    Add support for octal digits

commit 9562db817ff9045b882b42aae128e7d922bb2352
Author: 星外之神 <wszqkzqk@qq.com>
Date:   Sun Nov 20 13:10:15 2022 +0800

    Added support for older C compilers

commit 02ef76307ce8cd50fe61e7ab4e968c93d7251b6c
Author: 星外之神 <wszqkzqk@qq.com>
Date:   Sun Nov 20 10:16:34 2022 +0800

    add support for binary integer literal
---
 vala/valaintegerliteral.vala | 46 +++++++++++++++++++++++++++++++++++-
 vala/valascanner.vala        | 21 ++++++++--------
 2 files changed, 56 insertions(+), 11 deletions(-)

diff --git a/vala/valaintegerliteral.vala b/vala/valaintegerliteral.vala
index 4fc8e890b..bcc7ca165 100644
--- a/vala/valaintegerliteral.vala
+++ b/vala/valaintegerliteral.vala
@@ -82,7 +82,51 @@ public class Vala.IntegerLiteral : Literal {
 			value = value.substring (0, value.length - 1);
 		}
 
-		int64 n = int64.parse (value);
+		int64 n;
+		if (value.has_prefix ("0b")) {
+			uint64 m = 0;
+			string v = value.substring (2, value.length);
+			for (long i = v.length - 1; i > 0; i -= 1) {
+				if (v[i] == '1') {
+					if (v.length - 1 - i >= 64) {
+						Report.warning (source_reference, "integer constant is too large");
+						m = uint64.MAX;
+						break;
+					}
+					m += (1 << (v.length - 1 - i));
+				} else if (v[i] != '0') {
+					Report.error (source_reference, "invalid digit '%c' in binary literal".printf (v[i]));
+					error = true;
+					break;
+				}
+			}
+			value = m.to_string ();
+			n = (int64) m;
+		} else if (value.has_prefix ("0o")) {
+			uint64 m = 0;
+			string v = value.substring (2, value.length);
+			for (long i = v.length - 1; i > 0; i -= 1) {
+				if (v[i].isdigit () && v[i] != '8' && v[i] != '9') {
+					int num = v[i].digit_value ();
+					if ((num == 1 && ((v.length - 1 - i) * 3 >= 64))
+					|| (1 < num < 4 && ((v.length - 1 - i) * 3 + 1 >= 64))
+					|| (num >= 4 && ((v.length - 1 - i) * 3 + 2 >= 64))) {
+						Report.warning (source_reference, "integer constant is too large");
+						m = uint64.MAX;
+						break;
+					}
+					m += (num << ((v.length - 1 - i) * 3));
+				} else {
+					Report.error (source_reference, "invalid digit '%c' in binary literal".printf (v[i]));
+					error = true;
+					break;
+				}
+			}
+			value = m.to_string ();
+			n = (int64) m;
+		} else {
+			n = int64.parse (value);
+		}
 		if (!u && (n > int.MAX || n < int.MIN)) {
 			// value doesn't fit into signed 32-bit
 			l = 2;
diff --git a/vala/valascanner.vala b/vala/valascanner.vala
index 71a317edd..cc9ad83fb 100644
--- a/vala/valascanner.vala
+++ b/vala/valascanner.vala
@@ -607,18 +607,19 @@ public class Vala.Scanner {
 		var type = TokenType.INTEGER_LITERAL;
 
 		// integer part
-		if (current < end - 2 && current[0] == '0'
-		    && current[1] == 'x' && current[2].isxdigit ()) {
-			// hexadecimal integer literal
-			current += 2;
-			while (current < end) {
-				if (current[0].isxdigit ()) {
+		if (current < end - 2 && current[0] == '0') {
+			if (current[1] == 'x' && current[2].isxdigit ()) {
+				// hexadecimal integer literal
+				current += 2;
+				while (current < end && current[0].isxdigit ()) {
 					current++;
-				} else if (current[0] == '_' && current < end -1 && current[1].isxdigit ()) {
-					// Support the underscore symbol separates digits in number values
+				}
+			} else if ((current[1] == 'b' || current[1] == 'o')
+			&& current[2].isdigit ()) {
+				// binary integer literal or octal integer literal
+				current += 2;
+				while (current < end && current[0].isdigit ()) {
 					current++;
-				} else {
-					break;
 				}
 			}
 		} else {
-- 
2.38.1.windows.1


From 792cec62340a9a7765df37df9eaeadea68d98ab7 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?=E6=98=9F=E5=A4=96=E4=B9=8B=E7=A5=9E?= <wszqkzqk@qq.com>
Date: Sun, 20 Nov 2022 13:50:54 +0800
Subject: [PATCH 5/5] Squashed commit of the following:
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

commit 8d1dac0e622a33e81546319d9635ba362ac48793
Author: 星外之神 <wszqkzqk@qq.com>
Date:   Mon Oct 31 00:50:46 2022 +0800

    Adapt Unix filenames with `\`
---
 ccode/valaccodelinedirective.vala | 8 +++++++-
 1 file changed, 7 insertions(+), 1 deletion(-)

diff --git a/ccode/valaccodelinedirective.vala b/ccode/valaccodelinedirective.vala
index c5e61114b..6b121ce43 100644
--- a/ccode/valaccodelinedirective.vala
+++ b/ccode/valaccodelinedirective.vala
@@ -37,7 +37,13 @@ public class Vala.CCodeLineDirective : CCodeNode {
 	public int line_number { get; set; }
 
 	public CCodeLineDirective (string _filename, int _line) {
-		filename = _filename;
+		if (Path.DIR_SEPARATOR == '/') {
+			string[] components = _filename.split ("""\""");
+			filename = string.joinv ("""\\""", components);
+		}
+		else {
+			filename = _filename;
+		}
 		line_number = _line;
 	}
 
-- 
2.38.1.windows.1

